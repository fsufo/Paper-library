<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic Blog</title>
    <!-- ‰∏âÊñπÂ∫ì -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/3d-force-graph@1.73.1/dist/3d-force-graph.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* --- Âü∫Á°ÄÊ†∑Âºè --- */
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #000000; 
            color: #fff; 
            font-family: 'Segoe UI', sans-serif;
            /* 1. ÂúÜÊ∂¶ Q ÂºπËÉñÁÆ≠Â§¥ */
            cursor: url('data:image/svg+xml;utf8,<svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 3.5L11 20L14 12.5L21.5 9L5.5 3.5Z" fill="white" stroke="%23222" stroke-width="2.5" stroke-linejoin="round"/></svg>') 5 3, auto;
        }
        
        #3d-graph { width: 100vw; height: 100vh; position: absolute; z-index: 1; }

        /* --- ÊêúÁ¥¢Ê°Ü --- */
        #search-container {
            position: fixed; top: 20px; right: 30px; z-index: 50;
            background: rgba(10, 10, 15, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 8px 16px;
            display: flex; align-items: center;
            backdrop-filter: blur(5px);
            transition: border-color 0.3s;
        }
        #search-container:hover { border-color: rgba(255, 255, 255, 0.6); }
        #search-input {
            background: transparent; border: none; color: #fff;
            outline: none; font-size: 14px; width: 180px;
            margin-left: 8px; font-family: inherit;
        }
        .search-icon { font-size: 16px; color: #aaa; }

        /* --- ÊûÅÁÆÄÈ£ûË°åÁå´ --- */
        #helicopter-cat {
            position: fixed; pointer-events: none; z-index: 9999;
            width: 32px; height: 24px;
            top: -100px; left: -100px;
            will-change: transform, top, left;
        }
        .cat-body-container {
            width: 100%; height: 100%; position: relative;
            animation: float 2.5s ease-in-out infinite;
        }
        .cat-body {
            width: 32px; height: 22px; background: #fff;
            border-radius: 16px 16px 12px 12px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.6);
            position: absolute; bottom: 0;
            display: flex; justify-content: center; align-items: center;
        }
        .cat-ear {
            position: absolute; top: -4px;
            width: 0; height: 0;
            border-left: 5px solid transparent; border-right: 5px solid transparent;
            border-bottom: 10px solid #fff;
        }
        .cat-ear.left { left: 3px; transform: rotate(-15deg); }
        .cat-ear.right { right: 3px; transform: rotate(15deg); }
        .cat-face {
            position: absolute; top: 8px; width: 100%;
            display: flex; justify-content: center; gap: 6px;
        }
        .eye {
            width: 3px; height: 3px; background: #333;
            border-radius: 50%; transition: transform 0.1s, height 0.1s;
        }
        .eye.closed { height: 1px; transform: scaleX(1.5); background: #555; }
        .propeller {
            position: absolute; top: -10px; left: 50%;
            width: 28px; height: 2px; background: rgba(255, 255, 255, 0.9);
            transform: translateX(-50%); border-radius: 2px;
            animation: spin 0.08s linear infinite;
        }
        .propeller::after {
            content: ''; position: absolute; top: 100%; left: 50%;
            width: 2px; height: 6px; background: #ccc; transform: translateX(-50%);
        }
        #zzz-bubble {
            position: absolute; top: -20px; right: -15px;
            font-size: 10px; color: #fff; font-weight: bold;
            opacity: 0; transition: opacity 0.5s;
        }
        #zzz-bubble.active { opacity: 0.8; animation: floatUp 2s infinite; }
        
        @keyframes floatUp { 0% { transform: translateY(0); opacity: 0.8; } 100% { transform: translateY(-10px); opacity: 0; } }
        @keyframes spin { 0% { transform: translateX(-50%) rotateY(0deg); } 100% { transform: translateX(-50%) rotateY(360deg); } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(4px); } }

        /* --- ÊñáÁ´†ÈòÖËØªÂô® --- */
        #article-modal {
            display: none; position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(6, 6, 10, 0.96); 
            z-index: 1000;
            opacity: 0; transition: opacity 0.3s;
            overflow-y: auto;
        }
        #article-modal.active { display: block; opacity: 1; }
        
        .article-content {
            max-width: 800px; margin: 80px auto; padding: 40px;
            background: rgba(22, 27, 36, 0.4); 
            border: 1px solid rgba(48, 54, 61, 0.5);
            border-radius: 12px;
        }
        .close-btn { position: fixed; top: 30px; right: 50px; font-size: 32px; cursor: pointer; color: #aaa; z-index: 1100; }
        .close-btn:hover { color: #fff; transform: scale(1.1); }

        /* Markdown Reset */
        .markdown-body { line-height: 1.7; color: #e6edf3; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #30363d; padding-bottom: 0.3em; margin-top: 1.5em; color: #fff; }
        .markdown-body a { color: #4493f8; text-decoration: none; }
        .markdown-body a:hover { text-decoration: underline; }
        .markdown-body code { background: rgba(110, 118, 129, 0.4); padding: 0.2em 0.4em; border-radius: 6px; font-family: 'Consolas', monospace; }
        .markdown-body pre { background: #0d1117; padding: 16px; border-radius: 6px; overflow: auto; border: 1px solid #30363d; }
        .markdown-body img { max-width: 100%; border-radius: 6px; }

        .tip {
            position: fixed; top: 20px; left: 20px; z-index: 10;
            color: rgba(255,255,255,0.3); font-size: 12px; pointer-events: none;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

    <div id="3d-graph"></div>

    <div class="tip">UNIVERSE OS v3.1</div>

    <!-- ÊêúÁ¥¢Ê°Ü -->
    <div id="search-container">
        <span class="search-icon">üîç</span>
        <input type="text" id="search-input" placeholder="Search universe..." />
    </div>

    <!-- ÊûÅÁÆÄÈ£ûË°åÁå´ -->
    <div id="helicopter-cat">
        <div class="cat-body-container">
            <div id="zzz-bubble">Zzz...</div>
            <div class="propeller"></div>
            <div class="cat-ear left"></div>
            <div class="cat-ear right"></div>
            <div class="cat-body">
                <div class="cat-face">
                    <div class="eye left"></div>
                    <div class="eye right"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈòÖËØªÂô® -->
    <div id="article-modal">
        <div class="close-btn" onclick="closeArticle()">&times;</div>
        <div class="article-content markdown-body" id="markdown-container"></div>
    </div>

    <script>
        // --- 1. È´òÁ∫ßËßÜËßâÁîüÊàêÂô® ---
        /* ÁîüÊàêÊûÅÁªÜÂçÅÂ≠óÊòüËäí + Ê†∏ÂøÉÂÖâÊôï */
        function createGlowSprite(color, size, neighborsCount) {
            const canvas = document.createElement('canvas');
            canvas.width = 256; 
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            const c = 128;

            // A. Âü∫Á°ÄÂúÜÂΩ¢ÂÖâÊôï
            const grad = ctx.createRadialGradient(c, c, 0, c, c, 100);
            grad.addColorStop(0, 'rgba(255, 255, 255, 1)');
            grad.addColorStop(0.1, color);
            grad.addColorStop(0.6, color.replace('rgb', 'rgba').replace(')', ', 0.1)'));
            grad.addColorStop(1, 'rgba(0, 0, 0, 0)');
            
            ctx.fillStyle = grad;
            ctx.beginPath();
            ctx.arc(c, c, 100, 0, Math.PI * 2);
            ctx.fill();

            // B. ÊûÅÁªÜÂçÅÂ≠óÊòüËäí (Super Fine Rays)
            ctx.globalCompositeOperation = 'lighter';
            
            function drawRay(w, h, alpha) {
                const rGrad = ctx.createLinearGradient(0, c - h, 0, c + h);
                rGrad.addColorStop(0, 'rgba(0,0,0,0)');
                rGrad.addColorStop(0.5, `rgba(255,255,255,${alpha})`);
                rGrad.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = rGrad;
                ctx.fillRect(c - w/2, c - h, w, h * 2);
            }

            // Ê†∏ÂøÉËäÇÁÇπÊòüËäíÊõ¥Èïø
            const scale = 1 + (neighborsCount || 0) * 0.3;
            // ÁªÜÂà∞ 1px (256canvas‰∏äÁöÑ 1px Ê∏≤ÊüìÂá∫Êù•ÈùûÂ∏∏ÈîêÂà©)
            drawRay(1, 110 * scale, 0.9); 
            
            ctx.save();
            ctx.translate(c, c);
            ctx.rotate(Math.PI / 2); // 90Â∫¶
            ctx.translate(-c, -c);
            drawRay(1, 80 * scale, 0.9);
            ctx.restore();
            
            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ 
                map: tex, 
                transparent: true, 
                blending: THREE.AdditiveBlending,
                depthWrite: false
            });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(size, size, 1);
            
            // Â≠òÂÇ®Âä®ÁîªÂèÇÊï∞
            sprite.userData = {
                phase: Math.random() * Math.PI * 2,
                baseSize: size,
                speed: 0.5 + Math.random() // Èó™ÁÉÅÈÄüÂ∫¶
            };
            return sprite;
        }

        // --- 2. Ê†∏ÂøÉÂõæË°®ÈÄªËæë ---
        let highlightNodes = new Set();
        let highlightLinks = new Set();
        let hoverNode = null;
        let initialCameraPos = null;

        const Graph = ForceGraph3D()
            (document.getElementById('3d-graph'))
            .jsonUrl('./posts_data.json')
            .backgroundColor('#000000')
            .nodeLabel('label')
            
            // ËøûÁ∫øÊ†∑ÂºèÔºöÈ´ò‰∫ÆÊó∂Âèò‰∫ÆÂèòÁ≤ó
            .linkWidth(link => highlightLinks.has(link) ? 1.5 : 0.5)
            .linkColor(link => highlightLinks.has(link) ? 'rgba(255,255,255,0.8)' : 'rgba(100, 200, 255, 0.15)')
            .linkDirectionalParticles(link => highlightLinks.has(link) ? 3 : 0) // Âè™Êúâ hover Êó∂ÊòæÁ§∫ÊµÅÂä®Á≤íÂ≠ê
            .linkDirectionalParticleWidth(2)
            
            .nodeThreeObject(node => {
                // ËÆ°ÁÆó PageRank ÊïàÂ∫î (neighbors Âú®ÂêéÁª≠Âä†ËΩΩÔºåËøôÈáåÂèØËÉΩÈúÄË¶ÅÈò≤Âæ°ÊÄßÁºñÁ®ã)
                // ForceGraph3DÂä†ËΩΩÂÆå json Âêé‰ºöËá™Âä®ËÆ°ÁÆó neighborsÔºåÊâÄ‰ª•ËøôÈáåËøòÊ≤°ÊãøÂà∞Ôºü
                // ÂÆûÈôÖ‰∏ä nodeThreeObject ÊòØÂú®Êï∞ÊçÆÂä†ËΩΩÂêéË∞ÉÁî®ÁöÑÔºå‰ΩÜ neighbors Â±ûÊÄßÊòØ d3-force ‰∏∫‰∫Ü‰ªøÁúüÊ∑ªÂä†ÁöÑ
                // Á®≥Â¶•Ëµ∑ËßÅÔºåÊàë‰ª¨ÂÅáËÆæ node.neighbors Â≠òÂú®ÔºàÂ¶ÇÊûúÊàë‰ª¨Ëá™Â∑±È¢ÑÂ§ÑÁêÜ‰∫ÜÔºâÊàñËÄÖÈªòËÆ§‰∏∫0
                
                const degree = (node.neighbors && node.neighbors.length) || 0;
                
                let color = '#00aaff'; // ÈªòËÆ§Ëìù
                if(node.group === 'diary') color = '#ff66aa';
                if(node.group === 'tech') color = '#44ff88';
                if(node.group === 'ai') color = '#ff4444';
                if(node.id === 'README') color = '#ffcc00';

                // Ê†∏ÂøÉÊòüÁêÉÊòæËëóÂèòÂ§ß
                let size = 15 + degree * 5; 
                if(size > 60) size = 60; // Â∞ÅÈ°∂

                return createGlowSprite(color, size, degree);
            })
            .onNodeHover(node => {
                if(document.getElementById('article-modal').classList.contains('active')) return;

                hoverNode = node || null;
                document.body.style.cursor = node ? 'pointer' : null;
                
                highlightNodes.clear();
                highlightLinks.clear();
                
                if (node) {
                    highlightNodes.add(node);
                    // ÈÅçÂéÜËøûÁ∫øÊâæÈÇªÂ±Ö (Ëøô‰∏™Êìç‰ΩúÂú®Â§ßÂõæÈáåÂèØËÉΩÊÖ¢ÔºåÂá†Áôæ‰∏™ÁÇπÊ≤°ÈóÆÈ¢ò)
                    // Êõ¥Âø´ÁöÑÊòØÁõ¥Êé•ËÆøÈóÆ node.neighbors
                    if(node.neighbors) {
                       node.neighbors.forEach(neighbor => highlightNodes.add(neighbor));
                    }
                    // Ê†áËÆ∞ËøûÁ∫ø
                    Graph.graphData().links.forEach(link => {
                        if (link.source.id === node.id || link.target.id === node.id) {
                            highlightLinks.add(link);
                        }
                    });
                }
                
                updateHighlight();
            })
            .onNodeClick(node => {
                // ËÆ∞ÂΩï‰ΩçÁΩÆ
                const cam = Graph.camera();
                initialCameraPos = { x: cam.position.x, y: cam.position.y, z: cam.position.z };

                // ËøêÈïú
                const dist = 60;
                const ratio = 1 + dist/Math.hypot(node.x, node.y, node.z);
                Graph.cameraPosition(
                    { x: node.x * ratio, y: node.y * ratio, z: node.z * ratio }, 
                    node, 
                    1500
                );

                setTimeout(() => openArticle(node), 1000);
            });

        // --- 3. Êï∞ÊçÆÈ¢ÑÂ§ÑÁêÜ & ÂêØÂä® ---
        // Êàë‰ª¨ÈúÄË¶ÅËá™Â∑±ÊâãÂä® fetch ‰∏ÄÊ¨°Êù•ÊûÑÂª∫ neighborsÔºåÊàñËÄÖÁ≠âÂæÖ ForceGraph ÂÜÖÈÉ®ÊûÑÂª∫
        // ÊúÄÁ®≥Â¶•ÊòØÂä´ÊåÅ jsonUrl ÁöÑÂä†ËΩΩ
        fetch('./posts_data.json').then(r => r.json()).then(data => {
            // ÊûÑÂª∫ÈÇªÂ±ÖË°®
            const map = {};
            data.nodes.forEach(n => { n.neighbors = []; map[n.id] = n; });
            data.links.forEach(l => {
                const a = map[l.source];
                const b = map[l.target];
                if(a && b) {
                    a.neighbors.push(b);
                    b.neighbors.push(a);
                }
            });
            
            Graph.graphData(data);
            
            // ÂêØÂä®Èó™ÁÉÅÂä®Áîª
            animateStars();
        });


        // --- 4. ËßÜËßâÊõ¥Êñ∞ÈÄªËæë ---
        function updateHighlight() {
            const { nodes } = Graph.graphData();
            const isHovering = (hoverNode !== null);

            nodes.forEach(node => {
                const sprite = node.__threeObj;
                if (!sprite) return;

                if (!isHovering) {
                    // ÂÖ®Â±ÄÊÅ¢Â§ç
                    sprite.material.opacity = 1;
                } else if (highlightNodes.has(node)) {
                    // È´ò‰∫Æ
                    sprite.material.opacity = 1;
                } else {
                    // Ê∂àÈöê (Dim)
                    sprite.material.opacity = 0.1;
                }
            });

            // Ëß¶ÂèëËøûÁ∫øÊõ¥Êñ∞
            Graph.linkWidth(Graph.linkWidth()).linkColor(Graph.linkColor());
        }

        function animateStars() {
            const { nodes } = Graph.graphData();
            if (nodes) {
                const t = Date.now() * 0.002; // ÊÖ¢ÈÄüÂëºÂê∏
                nodes.forEach(node => {
                    const s = node.__threeObj;
                    // Âè™ÊúâÂú®ÈùûÊ∂àÈöêÁä∂ÊÄÅ‰∏ãÊâçÈó™ÁÉÅ
                    if(s && s.material.opacity > 0.5) {
                        const wave = 1 + Math.sin(t * s.userData.speed + s.userData.phase) * 0.15;
                        s.scale.set(s.userData.baseSize * wave, s.userData.baseSize * wave, 1);
                    }
                });
            }
            requestAnimationFrame(animateStars);
        }

        // --- 5. ËÉåÊôØÊòüÁ©∫Á≤íÂ≠ê ---
        const scene = Graph.scene();
        function addStarField() {
            const geo = new THREE.BufferGeometry();
            const count = 4000;
            const pos = new Float32Array(count * 3);
            const cols = new Float32Array(count * 3);
            for(let i=0; i<count; i++) {
                const r = 3000 * Math.random(); // ÂùáÂåÄÂàÜÂ∏ÉÂú®ÁêÉ‰ΩìÂÜÖ
                const theta = 2 * Math.PI * Math.random();
                const phi = Math.acos(2 * Math.random() - 1);
                pos[i*3] = r * Math.sin(phi) * Math.cos(theta);
                pos[i*3+1] = r * Math.sin(phi) * Math.sin(theta);
                pos[i*3+2] = r * Math.cos(phi);
                
                const c = new THREE.Color();
                c.setHSL(Math.random(), 0.2, 0.8); // Áï•Â∏¶È¢úËâ≤ÁöÑÁôΩ
                cols[i*3] = c.r; cols[i*3+1] = c.g; cols[i*3+2] = c.b;
            }
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.BufferAttribute(cols, 3));
            const mat = new THREE.PointsMaterial({ size: 1.5, vertexColors: true, transparent: true, opacity: 0.6 });
            scene.add(new THREE.Points(geo, mat));
        }
        setTimeout(addStarField, 1000);


        // --- 6. ÊêúÁ¥¢ ---
        document.getElementById('search-input').addEventListener('input', (e) => {
            const val = e.target.value.toLowerCase();
            if(!val) return;
            const { nodes } = Graph.graphData();
            const hit = nodes.find(n => (n.label||'').toLowerCase().includes(val));
            if(hit) {
                // Focus camera
                const dist = 80;
                const ratio = 1 + dist/Math.hypot(hit.x, hit.y, hit.z);
                Graph.cameraPosition({x:hit.x*ratio, y:hit.y*ratio, z:hit.z*ratio}, hit, 1000);
            }
        });


        // --- 7. ÊñáÁ´†ÁïåÈù¢ ---
        const modal = document.getElementById('article-modal');
        const box = document.getElementById('markdown-container');
        
        function openArticle(node) {
            if(!node || !node.content) return;
            box.innerHTML = marked.parse(node.content);
            modal.classList.add('active');
        }
        
        function closeArticle() {
            modal.classList.remove('active');
            // Â§ç‰ΩçÁõ∏Êú∫
            const p = initialCameraPos || {x:0, y:0, z:500};
            Graph.cameraPosition(p, {x:0,y:0,z:0}, 2000);
        }
        document.addEventListener('keydown', e => { if(e.key==='Escape') closeArticle(); });


        // --- 8. Áå´Áå´Áâ©ÁêÜ ---
        const cat = document.getElementById('helicopter-cat');
        const catBody = cat.querySelector('.cat-body-container');
        const leftEye = cat.querySelector('.eye.left');
        const rightEye = cat.querySelector('.eye.right');
        const zzz = document.getElementById('zzz-bubble');
        
        let mx = window.innerWidth/2, my = window.innerHeight/2;
        let cx = mx, cy = my, rot = 0;
        let sleeping = false, lastTv = Date.now();

        document.addEventListener('mousemove', e => { mx=e.clientX; my=e.clientY; lastTv=Date.now(); if(sleeping) wake(); });

        function blink() {
            if(sleeping) return;
            leftEye.classList.add('closed'); rightEye.classList.add('closed');
            setTimeout(() => { if(!sleeping) { leftEye.classList.remove('closed'); rightEye.classList.remove('closed'); } }, 200);
            setTimeout(blink, 2000 + Math.random() * 3000);
        }
        setTimeout(blink, 2000);

        function sleep() { sleeping=true; leftEye.classList.add('closed'); rightEye.classList.add('closed'); zzz.classList.add('active'); }
        function wake() { sleeping=false; leftEye.classList.remove('closed'); rightEye.classList.remove('closed'); zzz.classList.remove('active'); blink(); }

        function loop() {
            if(!sleeping && Date.now()-lastTv > 5000) sleep();
            
            const ease = 0.08;
            let tx = mx + 20, ty = my + 20;
            let nx = cx + (tx-cx)*ease, ny = cy + (ty-cy)*ease;
            let vx = nx - cx;
            
            let tr = vx * -2;
            tr = Math.max(-20, Math.min(20, tr));
            rot += (tr - rot)*0.1;
            
            cx = nx; cy = ny;
            cat.style.left = cx+'px'; cat.style.top = cy+'px';
            catBody.style.transform = `rotate(${rot}deg)`;
            
            if(!sleeping) {
                let off = Math.max(-2, Math.min(2, vx*0.5));
                leftEye.style.transform = `translateX(${off}px)`;
                rightEye.style.transform = `translateX(${off}px)`;
            }
            requestAnimationFrame(loop);
        }
        loop();
        
        window.onresize = () => Graph.width(window.innerWidth).height(window.innerHeight);

    </script>
</body>
</html>