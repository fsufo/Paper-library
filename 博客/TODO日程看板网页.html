<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ—¥ç¨‹çœ‹æ¿</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --column-bg: #161b22;
            --card-bg: #21262d;
            --text-color: #c9d1d9;
            --text-muted: #8b949e;
            --btn-color: #1f6feb;
            --btn-hover: #388bfd;
            --border-color: #30363d;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            zoom: 0.9; /* æ•´ä½“ç¼©å° 10% */
        }

        h1 {
            margin-bottom: 20px;
            text-align: center;
            color: var(--text-color);
        }

        .file-controls {
            text-align: center;
            margin-bottom: 20px;
            padding: 20px;
            background: var(--column-bg);
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            transition: all 0.2s;
        }

        .file-controls.drag-over {
            background-color: rgba(31, 111, 235, 0.1);
            border-color: #1f6feb;
        }

        .file-btn {
            background-color: #238636; /* GitHub Green */
            color: white;
            border: 1px solid rgba(240,246,252,0.1);
            padding: 6px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: 0.2s;
        }

        .file-btn:hover {
            background-color: #2ea043;
        }

        .save-status-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            font-size: 12px;
            color: var(--text-muted);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #30363d;
            margin-right: 5px;
            border: 1px solid var(--bg-color);
        }

        .status-indicator.saved { background-color: #238636; box-shadow: 0 0 5px #238636; }
        .status-indicator.pending { background-color: #d29922; box-shadow: 0 0 5px #d29922; }
        .status-indicator.error { background-color: #f85149; }

        .manual-save-btn {
            background: none;
            border: 1px solid var(--border-color);
            padding: 3px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            margin-top: 4px;
            transition: 0.2s;
        }
        
        .manual-save-btn:hover {
            background-color: var(--border-color);
            color: #58a6ff;
        }

        .board {
            display: flex;
            gap: 20px;
            overflow-x: auto;
            flex-grow: 1;
            align-items: flex-start;
            padding-bottom: 10px;
        }

        /* å“åº”å¼å¸ƒå±€ï¼šå½“å±å¹•å®½åº¦å°äº 950px æ—¶ï¼Œåˆ‡æ¢ä¸ºå‚ç›´å †å  */
        @media (max-width: 950px) {
            .board {
                flex-direction: column;
                align-items: stretch;
                overflow-x: hidden; /* éšè—æ°´å¹³æ»šåŠ¨æ¡ */
                overflow-y: auto;   /* å…è®¸å‚ç›´æ»šåŠ¨ */
            }

            .column {
                width: 100%;      /* å æ»¡å®½åº¦ */
                min-width: 0;     /* å…è®¸ç¼©å° */
                max-height: none; /* å–æ¶ˆé«˜åº¦é™åˆ¶ï¼Œéšå†…å®¹æ’‘å¼€ */
                margin-bottom: 20px;
            }

            .task-list {
                min-height: 50px; /* ç¨å¾®å‡å°æœ€å°é«˜åº¦ */
                max-height: 300px; /* é™åˆ¶æ¯ä¸ªåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ï¼Œé¿å…å¤ªé•¿ */
            }
        }

        /* Scrollbar styling for dark mode */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6e7681;
        }

        .column {
            background-color: var(--column-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            width: 300px;
            min-width: 300px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .column-header {
            font-weight: 600;
            margin-bottom: 12px;
            padding: 0 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-color);
        }
        
        .column-header span {
            background-color: rgba(110, 118, 129, 0.4);
            color: var(--text-color);
            border-radius: 2em;
            padding: 2px 8px;
            font-size: 12px;
            font-weight: 500;
        }

        .task-list {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨æ¡å‡ºç° */
            min-height: 100px;
            padding: 4px 10px 10px 10px; /* å¢åŠ å†…è¾¹è·ï¼Œä¸ºå¡ç‰‡æ”¾å¤§ç•™å‡ºç©ºé—´ */
        }

        .task-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            box-shadow: 0 1px 0 rgba(27,31,35,0.04);
            cursor: grab;
            position: relative;
            transition: 0.2s;
            color: var(--text-color);
            word-wrap: break-word;
        }

        .task-card:hover {
            background-color: #2c333e;
            border-color: #8b949e;
        }

        .task-card:active {
            cursor: grabbing;
            transform: rotate(1deg);
        }

        .task-card .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: none;
            border: none;
            cursor: pointer;
            display: none;
            padding: 0;
            border-radius: 50%;
            justify-content: center;
            align-items: center;
        }

        .task-card:hover .delete-btn {
            display: flex;
        }

        /* é•¿æŒ‰åˆ é™¤çš„ SVG åŠ¨ç”»æ ·å¼ */
        .delete-btn svg {
            width: 24px;
            height: 24px;
            transform: rotate(-90deg);
        }

        .delete-btn circle {
            fill: none;
            stroke-width: 2;
            stroke: #f85149;
            stroke-dasharray: 70; /* åœ†å‘¨é•¿ */
            stroke-dashoffset: 70; /* åˆå§‹éšè— */
            transition: stroke-dashoffset 0s linear; /* é»˜è®¤æ— è¿‡æ¸¡ */
        }

        .delete-btn.pressing circle {
            stroke-dashoffset: 0; /* å¡«æ»¡ */
            transition: stroke-dashoffset 0.4s linear; /* 0.4ç§’å¡«æ»¡ */
        }

        .delete-btn .x-icon {
            position: absolute;
            color: var(--text-muted);
            font-size: 16px;
            line-height: 1;
            pointer-events: none;
        }
        
        .delete-btn:hover .x-icon {
            color: #f85149;
        }

        /* ç¼–è¾‘æ¨¡å¼æ ·å¼ */
        .task-card textarea.edit-mode {
            width: 100%;
            background: var(--bg-color);
            color: var(--text-color);
            border: 1px solid #58a6ff;
            border-radius: 4px;
            padding: 4px;
            font-family: inherit;
            font-size: inherit;
            resize: none;
            box-sizing: border-box;
            outline: none;
            display: block;
        }

        /* æ‹–æ‹½å ä½ç¬¦æ ·å¼ */
        .drop-placeholder {
            height: 4px;
            background-color: #1f6feb;
            border-radius: 2px;
            margin: 4px 0;
            box-shadow: 0 0 4px #1f6feb;
            pointer-events: none; /* ä¸å¹²æ‰°é¼ æ ‡äº‹ä»¶ */
        }

        .add-task-container {
            margin-top: 8px;
        }

        .add-btn {
            background-color: transparent;
            color: var(--text-muted);
            border: none;
            cursor: pointer;
            padding: 8px;
            width: 100%;
            text-align: left;
            border-radius: 4px;
            transition: 0.2s;
        }

        .add-btn:hover {
            background-color: rgba(177, 186, 196, 0.12);
            color: var(--text-color);
        }

        .input-group {
            display: none;
        }

        .input-group textarea {
            width: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            box-sizing: border-box;
            resize: vertical;
            min-height: 60px;
            font-family: inherit;
            margin-bottom: 8px;
            outline: none;
        }
        
        .input-group textarea:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .input-group .actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .save-btn {
            background-color: var(--btn-color);
            color: white;
            border: 1px solid rgba(240,246,252,0.1);
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .save-btn:hover {
            background-color: var(--btn-hover);
        }

        .cancel-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
        }
        
        .cancel-btn:hover {
            color: var(--text-color);
        }

        /* Drag and Drop Styles */
        .task-card.dragging {
            opacity: 0.4;
            border: 1px dashed var(--text-muted);
            background-color: var(--bg-color);
            transform: scale(0.95); /* æ‹–æ‹½æ—¶ç¨å¾®ç¼©å° */
        }

        .column.drag-over {
            background-color: #1c2128;
            border-color: #58a6ff;
        }

        /* Qå¼¹åŠ¨ç”»ï¼šå¡ç‰‡æ’å…¥ */
        @keyframes elastic-drop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.05); opacity: 1; }
            70% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        .task-card.animate-drop {
            animation: elastic-drop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            z-index: 10; /* ç¡®ä¿åŠ¨ç”»æ—¶åœ¨æœ€ä¸Šå±‚ */
            position: relative;
        }

        /* Qå¼¹åˆ é™¤åŠ¨ç”» */
        @keyframes elastic-remove {
            0% { transform: scale(1); opacity: 1; }
            40% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(0); opacity: 0; margin-top: -50px; } /* è´Ÿè¾¹è·è®©ä¸‹æ–¹å¡ç‰‡ä¸Šç§» */
        }

        .task-card.animate-delete {
            animation: elastic-remove 0.4s ease-in forwards;
            z-index: 10;
            pointer-events: none; /* åŠ¨ç”»æœŸé—´ç¦æ­¢äº¤äº’ */
        }

        /* å ä½ç¬¦åŠ¨ç”» */
        .drop-placeholder {
            height: 4px;
            background-color: #1f6feb;
            border-radius: 2px;
            margin: 4px 0;
            box-shadow: 0 0 8px rgba(31, 111, 235, 0.8);
            animation: placeholder-pulse 1s infinite alternate;
        }

        @keyframes placeholder-pulse {
            from { opacity: 0.6; transform: scaleX(0.95); }
            to { opacity: 1; transform: scaleX(1); }
        }
    </style>
</head>
<body>

    <h1>ğŸ“… æˆ‘çš„æ—¥ç¨‹çœ‹æ¿</h1>

    <div class="file-controls" id="drop-zone">
        <button class="file-btn" onclick="openFile()">ğŸ“‚ å…³è” Markdown æ–‡ä»¶</button>
        <span style="font-size: 12px; color: var(--text-muted);">æˆ–å°† .md æ–‡ä»¶æ‹–å…¥æ­¤å¤„</span>
        
        <div class="save-status-container" id="status-container" style="display:none;">
            <div>
                <span class="status-indicator saved" id="status-dot"></span>
                <span id="file-status-text">å·²åŒæ­¥</span>
            </div>
            <button class="manual-save-btn" onclick="forceSave()">ğŸ’¾ ç«‹å³ä¿å­˜åˆ°æ–‡ä»¶</button>
        </div>
    </div>

    <div class="board">
        <!-- To Do Column -->
        <div class="column" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
            <div class="column-header">ğŸ“ å¾…åŠäº‹é¡¹ (To Do) <span id="count-todo">0</span></div>
            <div class="task-list" id="list-todo">
                <!-- Tasks will be injected here -->
            </div>
            <div class="add-task-container">
                <button class="add-btn" onclick="showInput('todo')">+ æ·»åŠ å¡ç‰‡</button>
                <div class="input-group" id="input-todo">
                    <textarea placeholder="ä¸ºæ­¤å¡ç‰‡è¾“å…¥æ ‡é¢˜..." id="text-todo"></textarea>
                    <div class="actions">
                        <button class="save-btn" onclick="addTask('todo')">æ·»åŠ å¡ç‰‡</button>
                        <button class="cancel-btn" onclick="hideInput('todo')">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- In Progress Column -->
        <div class="column" id="inprogress" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
            <div class="column-header">ğŸš§ è¿›è¡Œä¸­ (In Progress) <span id="count-inprogress">0</span></div>
            <div class="task-list" id="list-inprogress"></div>
            <div class="add-task-container">
                <button class="add-btn" onclick="showInput('inprogress')">+ æ·»åŠ å¡ç‰‡</button>
                <div class="input-group" id="input-inprogress">
                    <textarea placeholder="ä¸ºæ­¤å¡ç‰‡è¾“å…¥æ ‡é¢˜..." id="text-inprogress"></textarea>
                    <div class="actions">
                        <button class="save-btn" onclick="addTask('inprogress')">æ·»åŠ å¡ç‰‡</button>
                        <button class="cancel-btn" onclick="hideInput('inprogress')">&times;</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Done Column -->
        <div class="column" id="done" ondrop="drop(event)" ondragover="allowDrop(event)" ondragleave="dragLeave(event)">
            <div class="column-header">âœ… å·²å®Œæˆ (Done) <span id="count-done">0</span></div>
            <div class="task-list" id="list-done"></div>
            <div class="add-task-container">
                <button class="add-btn" onclick="showInput('done')">+ æ·»åŠ å¡ç‰‡</button>
                <div class="input-group" id="input-done">
                    <textarea placeholder="ä¸ºæ­¤å¡ç‰‡è¾“å…¥æ ‡é¢˜..." id="text-done"></textarea>
                    <div class="actions">
                        <button class="save-btn" onclick="addTask('done')">æ·»åŠ å¡ç‰‡</button>
                        <button class="cancel-btn" onclick="hideInput('done')">&times;</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileHandle = null;
        let saveTimer = null;
        let lastSaveTime = Date.now();
        let lastSavedContent = ''; // è®°å½•ä¸Šæ¬¡ä¿å­˜çš„å†…å®¹
        const SAVE_DELAY = 30000; // å»¶è¿Ÿ 30 ç§’å†™å…¥æ–‡ä»¶

        // æ‹–æ‹½ç›¸å…³å…¨å±€å˜é‡
        let draggedItem = null;
        let sourceColumnId = null;
        let sourceIndex = null;
        let animationTarget = null; // ç”¨äºè®°å½•éœ€è¦æ’­æ”¾åŠ¨ç”»çš„å¡ç‰‡ä½ç½® {status, index}
        let placeholder = document.createElement('div');
        placeholder.className = 'drop-placeholder';

        // --- IndexedDB & åˆå§‹åŒ–é€»è¾‘ (ä¿æŒä¸å˜) ---
        const DB_NAME = 'MyBoardDB';
        const STORE_NAME = 'fileHandles';

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, 1);
                request.onupgradeneeded = (e) => {
                    e.target.result.createObjectStore(STORE_NAME);
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        async function saveHandleToDB(handle) {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).put(handle, 'lastUsedFile');
        }

        async function getHandleFromDB() {
            const db = await openDB();
            return new Promise((resolve) => {
                const tx = db.transaction(STORE_NAME, 'readonly');
                const request = tx.objectStore(STORE_NAME).get('lastUsedFile');
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(null);
            });
        }

        // --- åˆå§‹åŒ–é€»è¾‘ ---
        
        // é¡µé¢åŠ è½½æ—¶ï¼Œå°è¯•ä»æ•°æ®åº“æ¢å¤ä¸Šæ¬¡çš„æ–‡ä»¶
        window.addEventListener('load', async () => {
            setupDragAndDrop(); // åˆå§‹åŒ–æ‹–æ‹½ä¸Šä¼ åŒºåŸŸ

            const savedHandle = await getHandleFromDB();
            if (savedHandle) {
                fileHandle = savedHandle;
                const btn = document.querySelector('.file-btn');
                btn.textContent = `ğŸ“‚ ç‚¹å‡»é‡è¿: ${savedHandle.name}`;
                btn.onclick = verifyPermissionAndLoad; // æ”¹å˜æŒ‰é’®è¡Œä¸º
                btn.style.backgroundColor = '#1f6feb'; // æç¤ºè‰²
            }
            render(); // æ¸²æŸ“ LocalStorage ä¸­çš„ç¼“å­˜æ•°æ®
        });

        // åˆå§‹åŒ–æ•°æ® (é»˜è®¤ä» LocalStorage åŠ è½½)
        let tasks = JSON.parse(localStorage.getItem('myBoardTasks')) || {
            todo: ['åˆ¶å®šå‘¨è®¡åˆ’', 'å›å¤é‡è¦é‚®ä»¶'],
            inprogress: ['ç¼–å†™é¡¹ç›®ä»£ç '],
            done: ['æ™¨ä¼š']
        };

        // æ¸²æŸ“é¡µé¢
        function render() {
            ['todo', 'inprogress', 'done'].forEach(status => {
                const listEl = document.getElementById(`list-${status}`);
                const countEl = document.getElementById(`count-${status}`);
                
                // ä¿å­˜å½“å‰çš„æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢æ¸²æŸ“åè·³åŠ¨
                const scrollTop = listEl.scrollTop;
                
                listEl.innerHTML = '';
                
                tasks[status].forEach((taskText, index) => {
                    const card = createCardElement(taskText, status, index);
                    
                    // å¦‚æœæ˜¯åˆšæ‹–æ‹½æ”¾å…¥çš„å¡ç‰‡ï¼Œæ·»åŠ åŠ¨ç”»ç±»
                    if (animationTarget && animationTarget.status === status && animationTarget.index === index) {
                        card.classList.add('animate-drop');
                    }
                    
                    listEl.appendChild(card);
                });

                countEl.textContent = tasks[status].length;
                listEl.scrollTop = scrollTop;
            });
            
            // æ¸²æŸ“å®Œæˆåæ¸…é™¤åŠ¨ç”»ç›®æ ‡ï¼Œé¿å…ä¸‹æ¬¡æ¸²æŸ“é‡å¤æ’­æ”¾
            animationTarget = null;
            
            localStorage.setItem('myBoardTasks', JSON.stringify(tasks));
        }

        // åˆ›å»ºå¡ç‰‡ DOM å…ƒç´  (å°è£…ä»¥ä¾¿å¤ç”¨)
        function createCardElement(text, status, index) {
            const card = document.createElement('div');
            card.className = 'task-card';
            card.draggable = true;
            card.dataset.status = status;
            card.dataset.index = index;
            
            // æ‹–æ‹½äº‹ä»¶ç»‘å®š
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            // 1. æ–‡æœ¬å†…å®¹ (ç‚¹å‡»ç¼–è¾‘)
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            textSpan.style.display = 'block';
            textSpan.style.wordBreak = 'break-word';
            textSpan.onclick = (e) => {
                e.stopPropagation(); // é˜²æ­¢è§¦å‘å¡ç‰‡çš„å…¶ä»–ç‚¹å‡»äº‹ä»¶
                enableEditMode(card, textSpan, status, index);
            };
            card.appendChild(textSpan);

            // 2. é•¿æŒ‰åˆ é™¤æŒ‰é’®
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.title = 'é•¿æŒ‰åˆ é™¤';
            
            // SVG åœ†ç¯è¿›åº¦æ¡
            delBtn.innerHTML = `
                <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="11"></circle></svg>
                <span class="x-icon">&times;</span>
            `;

            // é•¿æŒ‰é€»è¾‘
            let pressTimer;
            const startPress = () => {
                delBtn.classList.add('pressing');
                pressTimer = setTimeout(() => {
                    // å…³é”®ä¿®å¤ï¼šå¦‚æœæŒ‰é’®å·²ç»è¢«ç§»é™¤ï¼ˆä¾‹å¦‚å‘ç”Ÿäº†é‡ç»˜ï¼‰ï¼Œåˆ™ä¸æ‰§è¡Œåˆ é™¤
                    if (document.body.contains(delBtn)) {
                        deleteTask(status, index);
                    }
                }, 400); // 0.4ç§’ååˆ é™¤
            };
            const cancelPress = () => {
                delBtn.classList.remove('pressing');
                clearTimeout(pressTimer);
            };

            delBtn.addEventListener('mousedown', startPress);
            delBtn.addEventListener('mouseup', cancelPress);
            delBtn.addEventListener('mouseleave', cancelPress);
            // è§¦æ‘¸å±æ”¯æŒ
            delBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startPress(); });
            delBtn.addEventListener('touchend', cancelPress);

            card.appendChild(delBtn);
            return card;
        }

        // --- ç¼–è¾‘åŠŸèƒ½ ---
        function enableEditMode(card, textSpan, status, index) {
            const originalText = textSpan.textContent;
            
            // åˆ›å»ºè¾“å…¥æ¡†æ›¿ä»£æ–‡æœ¬
            const textarea = document.createElement('textarea');
            textarea.className = 'edit-mode';
            textarea.value = originalText;
            
            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            textarea.style.height = Math.max(60, textSpan.offsetHeight + 10) + 'px';

            // æ›¿æ¢ DOM
            card.replaceChild(textarea, textSpan);
            textarea.focus();

            // ä¿å­˜é€»è¾‘
            const saveEdit = () => {
                const newText = textarea.value.trim();
                if (newText && newText !== originalText) {
                    tasks[status][index] = newText;
                    onDataChanged(); // è§¦å‘ä¿å­˜å’Œé‡ç»˜
                } else {
                    // å¦‚æœæ²¡å˜æˆ–ä¸ºç©ºï¼Œæ¢å¤åŸæ · (é‡ç»˜æœ€ç®€å•)
                    render(); 
                }
            };

            // å¤±ç„¦æˆ–å›è½¦ä¿å­˜
            textarea.addEventListener('blur', saveEdit);
            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    textarea.blur(); // è§¦å‘ blur ä¿å­˜
                }
            });
        }

        // --- æ‹–æ‹½æ’åºé€»è¾‘ (æ ¸å¿ƒé‡æ„) ---

        function handleDragStart(e) {
            draggedItem = this;
            sourceColumnId = this.dataset.status;
            sourceIndex = parseInt(this.dataset.index);
            
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({status: sourceColumnId, index: sourceIndex}));
            
            // å»¶è¿Ÿæ·»åŠ æ ·å¼ï¼Œè®©æ‹–æ‹½çš„â€œå¹½çµâ€å›¾ç‰‡æ˜¯åŸæ ·ï¼Œè€Œæºå…ƒç´ å˜æ·¡
            setTimeout(() => this.classList.add('dragging'), 0);
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            if (placeholder.parentNode) {
                placeholder.parentNode.removeChild(placeholder);
            }
            draggedItem = null;
            
            // ç§»é™¤æ‰€æœ‰åˆ—çš„é«˜äº®
            document.querySelectorAll('.column').forEach(col => col.classList.remove('drag-over'));
        }

        // å…è®¸æ”¾ç½® (ç»‘å®šåœ¨ Column ä¸Š)
        function allowDrop(e) {
            e.preventDefault();
            const column = e.target.closest('.column');
            if (!column) return;

            column.classList.add('drag-over');

            const list = column.querySelector('.task-list');
            const afterElement = getDragAfterElement(list, e.clientY);
            
            if (afterElement == null) {
                list.appendChild(placeholder);
            } else {
                list.insertBefore(placeholder, afterElement);
            }
        }

        // ç¦»å¼€åˆ—åŒºåŸŸ
        function dragLeave(e) {
            const column = e.target.closest('.column');
            // åªæœ‰å½“çœŸæ­£ç¦»å¼€ column æ—¶æ‰ç§»é™¤æ ·å¼ (é¿å…å­å…ƒç´ è§¦å‘)
            if (column && !column.contains(e.relatedTarget)) {
                column.classList.remove('drag-over');
                if (placeholder.parentNode === column.querySelector('.task-list')) {
                    placeholder.parentNode.removeChild(placeholder);
                }
            }
        }

        // æ”¾ç½® (Drop)
        function drop(e) {
            e.preventDefault();
            const column = e.target.closest('.column');
            if (!column) return;
            
            column.classList.remove('drag-over');
            const targetStatus = column.id; // 'todo', 'inprogress', 'done'

            // è®¡ç®—ç›®æ ‡ç´¢å¼•
            // æˆ‘ä»¬é€šè¿‡ placeholder åœ¨åˆ—è¡¨ä¸­çš„ä½ç½®æ¥å†³å®šæ’å…¥ç´¢å¼•
            const list = column.querySelector('.task-list');
            const children = Array.from(list.children);
            let targetIndex = children.indexOf(placeholder);
            
            // å¦‚æœ placeholder è¿˜åœ¨é‡Œé¢ï¼Œè¯´æ˜æ˜¯æœ‰æ•ˆæ”¾ç½®
            if (targetIndex !== -1) {
                // ç§»åŠ¨æ•°æ®
                const itemText = tasks[sourceColumnId][sourceIndex];
                
                // 1. å…ˆä»æºæ•°ç»„åˆ é™¤
                tasks[sourceColumnId].splice(sourceIndex, 1);
                
                // 2. ä¿®æ­£ç›®æ ‡ç´¢å¼• (å¦‚æœæ˜¯åŒåˆ—ç§»åŠ¨ï¼Œä¸”å‘ä¸‹æ‹–åŠ¨ï¼Œåˆ é™¤æºå…ƒç´ åç´¢å¼•ä¼šå˜åŒ–)
                if (sourceColumnId === targetStatus && sourceIndex < targetIndex) {
                    targetIndex--; 
                }

                // 3. æ’å…¥åˆ°ç›®æ ‡ä½ç½®
                tasks[targetStatus].splice(targetIndex, 0, itemText);
                
                // è®¾ç½®åŠ¨ç”»ç›®æ ‡ï¼Œè®© render å‡½æ•°ç»™è¿™ä¸ªæ–°ä½ç½®çš„å¡ç‰‡åŠ åŠ¨ç”»
                animationTarget = { status: targetStatus, index: targetIndex };

                onDataChanged();
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®é¼ æ ‡ Y åæ ‡è·å–æœ€è¿‘çš„åˆ—è¡¨é¡¹
        function getDragAfterElement(container, y) {
            // è·å–å®¹å™¨å†…æ‰€æœ‰é dragging çš„å¡ç‰‡
            const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                // è®¡ç®—é¼ æ ‡è·ç¦»å¡ç‰‡ä¸­å¿ƒçš„å‚ç›´åç§»é‡
                const offset = y - box.top - box.height / 2;
                
                // offset < 0 æ„å‘³ç€é¼ æ ‡åœ¨å…ƒç´ ä¸Šæ–¹
                // æˆ‘ä»¬è¦æ‰¾çš„æ˜¯ offset ä¸ºè´Ÿä¸”ç»å¯¹å€¼æœ€å°çš„é‚£ä¸ªå…ƒç´  (å³é¼ æ ‡æ­£ä¸Šæ–¹çš„é‚£ä¸ªå…ƒç´ )
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // --- å…¶ä»–é€»è¾‘ (ä¿æŒä¸å˜) ---
        
        // æ•°æ®å˜æ›´è§¦å‘å™¨
        function onDataChanged() {
            render();
            if (fileHandle) {
                scheduleSave();
            }
        }

        // å»¶è¿Ÿä¿å­˜é€»è¾‘ (é˜²æŠ–)
        function scheduleSave() {
            const statusText = document.getElementById('file-status-text');
            const statusDot = document.getElementById('status-dot');
            
            statusDot.className = 'status-indicator pending';
            statusText.textContent = 'æœ‰æ›´æ”¹ï¼Œ30ç§’åå†™å…¥æ–‡ä»¶...';
            
            if (saveTimer) clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveFile();
            }, SAVE_DELAY);
        }

        function forceSave() {
            if (saveTimer) clearTimeout(saveTimer);
            saveFile();
        }

        // éªŒè¯æƒé™å¹¶åŠ è½½ (ç”¨äºé‡è¿)
        async function verifyPermissionAndLoad() {
            if (!fileHandle) return openFile();

            const options = { mode: 'readwrite' };
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æƒé™
            if ((await fileHandle.queryPermission(options)) === 'granted') {
                await loadFileContent();
                return;
            }

            // è¯·æ±‚æƒé™
            if ((await fileHandle.requestPermission(options)) === 'granted') {
                await loadFileContent();
            } else {
                alert('éœ€è¦æˆæƒæ‰èƒ½åŒæ­¥æ–‡ä»¶ã€‚');
            }
        }

        // æ‰“å¼€æ–°æ–‡ä»¶
        async function openFile() {
            try {
                [fileHandle] = await window.showOpenFilePicker({
                    types: [{
                        description: 'Markdown Files',
                        accept: { 'text/markdown': ['.md'] },
                    }],
                    multiple: false
                });
                
                await loadFileContent();
                
            } catch (err) {
                if (err.name !== 'AbortError') {
                    console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', err);
                    alert('æ— æ³•æ‰“å¼€æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ä½¿ç”¨ Chrome/Edge æµè§ˆå™¨ã€‚');
                }
            }
        }

        // è¯»å–æ–‡ä»¶å†…å®¹çš„é€šç”¨é€»è¾‘
        async function loadFileContent() {
            try {
                const file = await fileHandle.getFile();
                const text = await file.text();
                
                if (text.trim().length > 0) {
                    parseMarkdown(text);
                    // è§£æåç«‹å³ç”Ÿæˆæ ‡å‡†æ ¼å¼ï¼Œä½œä¸ºåŸºå‡†ï¼Œé¿å…æ ¼å¼å·®å¼‚å¯¼è‡´çš„è¯¯åˆ¤
                    lastSavedContent = generateMarkdown();
                } else {
                    saveFile(); // æ–°æ–‡ä»¶åˆ™å†™å…¥å½“å‰æ•°æ®
                }
                
                // å­˜å…¥ IndexedDB ä»¥ä¾¿ä¸‹æ¬¡è‡ªåŠ¨è®°å¿†
                await saveHandleToDB(fileHandle);

                // æ›´æ–° UI
                document.getElementById('status-container').style.display = 'flex';
                const btn = document.querySelector('.file-btn');
                btn.textContent = `ğŸ“‚ å·²è¿æ¥: ${file.name}`;
                btn.onclick = openFile; // å…è®¸å†æ¬¡ç‚¹å‡»åˆ‡æ¢æ–‡ä»¶
                btn.style.backgroundColor = '#238636'; // ç»¿è‰²è¡¨ç¤ºæˆåŠŸ
                document.getElementById('file-status-text').textContent = 'å·²å…³è”ï¼Œå‡†å¤‡å°±ç»ª';
                
                render();
            } catch (err) {
                console.error('è¯»å–å¤±è´¥', err);
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        async function saveFile() {
            if (!fileHandle) return;

            const statusText = document.getElementById('file-status-text');
            const statusDot = document.getElementById('status-dot');

            try {
                const text = generateMarkdown();

                // æ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰å˜æ›´
                if (text === lastSavedContent) {
                    statusDot.className = 'status-indicator saved';
                    statusText.textContent = `å·²ä¿å­˜ (æ— å˜æ›´)`;
                    return;
                }

                statusText.textContent = 'æ­£åœ¨å†™å…¥æ–‡ä»¶...';
                
                const writable = await fileHandle.createWritable();
                await writable.write(text);
                await writable.close();
                
                // æ›´æ–°çŠ¶æ€
                lastSavedContent = text; // æ›´æ–°åŸºå‡†å†…å®¹
                lastSaveTime = Date.now();
                statusDot.className = 'status-indicator saved';
                statusText.textContent = `å·²ä¿å­˜ (${new Date().toLocaleTimeString()})`;
                
            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                statusDot.className = 'status-indicator error';
                statusText.textContent = 'âš ï¸ ä¿å­˜å¤±è´¥ (æ–‡ä»¶å¯èƒ½è¢«å ç”¨)';
                
                // å¦‚æœå¤±è´¥ï¼Œå°è¯• 5 ç§’åé‡è¯•
                saveTimer = setTimeout(saveFile, 5000);
            }
        }

        // è§£æ Markdown
        function parseMarkdown(text) {
            const lines = text.split('\n');
            const newTasks = { todo: [], inprogress: [], done: [] };
            let currentSection = null;

            for (let line of lines) {
                line = line.trim();
                if (line.includes('å¾…åŠäº‹é¡¹') || line.includes('To Do')) {
                    currentSection = 'todo';
                } else if (line.includes('è¿›è¡Œä¸­') || line.includes('In Progress')) {
                    currentSection = 'inprogress';
                } else if (line.includes('å·²å®Œæˆ') || line.includes('Done')) {
                    currentSection = 'done';
                } else if (line.startsWith('##')) {
                    currentSection = null;
                }

                if (currentSection && (line.startsWith('- [ ]') || line.startsWith('- [x]'))) {
                    const content = line.replace(/^-\s\[[ x]\]\s+/, '').trim();
                    if (content) newTasks[currentSection].push(content);
                }
            }
            tasks = newTasks;
        }

        // ç”Ÿæˆ Markdown
        function generateMarkdown() {
            let md = `# ğŸ“… æˆ‘çš„æ—¥ç¨‹çœ‹æ¿\n\n`;
            md += `> æœ€åæ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}\n`;
            md += `> æ­¤æ–‡ä»¶ç”±æ—¥ç¨‹çœ‹æ¿ç½‘é¡µè‡ªåŠ¨ç”Ÿæˆã€‚\n\n`;

            md += `## ğŸ“ å¾…åŠäº‹é¡¹ (To Do)\n\n`;
            tasks.todo.forEach(t => md += `- [ ] ${t}\n`);
            md += `\n`;

            md += `## ğŸš§ è¿›è¡Œä¸­ (In Progress)\n\n`;
            tasks.inprogress.forEach(t => md += `- [ ] ${t}\n`);
            md += `\n`;

            md += `## âœ… å·²å®Œæˆ (Done)\n\n`;
            tasks.done.forEach(t => md += `- [x] ${t}\n`);
            md += `\n`;

            md += `***\n\n## ğŸ—‘ï¸ æç½®/å–æ¶ˆ\n\n- [ ] \n`;
            return md;
        }

        // è®¾ç½®æ‹–æ‹½åŒºåŸŸ
        function setupDragAndDrop() {
            const dropZone = document.getElementById('drop-zone');

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                const items = [...e.dataTransfer.items];
                const item = items[0];

                if (item && item.kind === 'file') {
                    if (item.getAsFileSystemHandle) {
                        const handle = await item.getAsFileSystemHandle();
                        if (handle.kind === 'file' && handle.name.endsWith('.md')) {
                            fileHandle = handle;
                            await loadFileContent();
                            return;
                        }
                    }
                    alert('ä¸ºäº†æ”¯æŒè‡ªåŠ¨ä¿å­˜åŠŸèƒ½ï¼Œè¯·ç‚¹å‡»æŒ‰é’®é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–è€…ç¡®ä¿æµè§ˆå™¨æ”¯æŒæ–‡ä»¶ç³»ç»Ÿè®¿é—® APIã€‚');
                }
            });
        }

        // åˆ é™¤ä»»åŠ¡ (å¸¦åŠ¨ç”»)
        function deleteTask(columnId, index) {
            // éœ‡åŠ¨åé¦ˆ
            if (navigator.vibrate) navigator.vibrate(50);
            
            const list = document.getElementById(`list-${columnId}`);
            const card = list.children[index];

            if (card) {
                // æ’­æ”¾åˆ é™¤åŠ¨ç”»
                card.classList.add('animate-delete');
                
                // ç­‰å¾…åŠ¨ç”»ç»“æŸåå†çœŸæ­£åˆ é™¤æ•°æ®
                setTimeout(() => {
                    tasks[columnId].splice(index, 1);
                    onDataChanged();
                }, 350); // ç•¥å°äºåŠ¨ç”»æ—¶é—´ï¼Œæ„Ÿè§‰æ›´è¿è´¯
            } else {
                // å®¹é”™å¤„ç†
                tasks[columnId].splice(index, 1);
                onDataChanged();
            }
        }

        // æ˜¾ç¤ºè¾“å…¥æ¡†
        function showInput(columnId) {
            document.querySelector(`#${columnId} .add-btn`).style.display = 'none';
            document.querySelector(`#${columnId} .input-group`).style.display = 'block';
            document.getElementById(`text-${columnId}`).focus();
        }

        // éšè—è¾“å…¥æ¡†
        function hideInput(columnId) {
            document.querySelector(`#${columnId} .add-btn`).style.display = 'block';
            document.querySelector(`#${columnId} .input-group`).style.display = 'none';
            document.getElementById(`text-${columnId}`).value = '';
        }

        // æ·»åŠ ä»»åŠ¡
        function addTask(columnId) {
            const input = document.getElementById(`text-${columnId}`);
            const text = input.value.trim();
            if (text) {
                tasks[columnId].push(text);
                
                // è®¾ç½®åŠ¨ç”»ç›®æ ‡ï¼šæ–°æ·»åŠ çš„å¡ç‰‡ï¼ˆä½äºæœ€åï¼‰
                animationTarget = { status: columnId, index: tasks[columnId].length - 1 };
                
                onDataChanged();
                input.value = '';
                input.focus(); 
            }
        }


        // åˆå§‹æ¸²æŸ“
        render();

        // ç›‘å¬ Enter é”®æäº¤
        document.querySelectorAll('textarea').forEach(area => {
            area.addEventListener('keypress', function (e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const columnId = this.id.split('-')[1];
                    addTask(columnId);
                }
            });
        });

        // --- å®‰å…¨ä¿å­˜é€»è¾‘ ---
        
        // é¡µé¢éšè—/åˆ‡æ¢æ—¶å°è¯•ä¿å­˜
        window.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
                forceSave();
            }
        });

        // é¡µé¢å…³é—­å‰æ£€æŸ¥
        window.addEventListener('beforeunload', (e) => {
            if (fileHandle) {
                const currentContent = generateMarkdown();
                if (currentContent !== lastSavedContent) {
                    // å°è¯•è§¦å‘ä¿å­˜
                    forceSave();
                    
                    // è§¦å‘æµè§ˆå™¨æ‹¦æˆªå¼¹çª—ï¼Œä¸ºå¼‚æ­¥ä¿å­˜äº‰å–æ—¶é—´
                    // æ³¨æ„ï¼šç°ä»£æµè§ˆå™¨å¯èƒ½ä¸ä¼šæ˜¾ç¤ºè‡ªå®šä¹‰æ–‡æœ¬ï¼Œä½†ä¼šæç¤ºç”¨æˆ·
                    e.preventDefault();
                    e.returnValue = 'æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ';
                }
            }
        });

    </script>
</body>
</html>